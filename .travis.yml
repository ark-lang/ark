language: go

# which go versions do we target?
go:
 - 1.4.2

notifications:
 email: false

before_install:
 - sudo sh -c "echo 'deb http://llvm.org/apt/precise/ llvm-toolchain-precise-3.6 main' >> /etc/apt/sources.list"
 - wget -O - http://llvm.org/apt/llvm-snapshot.gpg.key | sudo apt-key add -
 # g++4.8.1
 - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test

# install is for dependencies
install:
 - sudo apt-get -qq update
 - sudo apt-get -qq install llvm-3.6 llvm-3.6-dev libedit2 libedit-dev libconfig++8-dev
 # we need a more recent g++ to build the llvm bindings
 - sudo apt-get -qq install g++-4.9; export CXX="g++-4.9";
 # dynamic llvm version fetching that is probably overkill
 - export LLVM_VERSION="`llvm-config-3.6 --version | sed -e 's/\.//g'`"
 - svn co --quiet https://llvm.org/svn/llvm-project/llvm/tags/RELEASE_$LLVM_VERSION/final $GOPATH/src/llvm.org/llvm ||
   svn co --quiet https://llvm.org/svn/llvm-project/llvm/tags/RELEASE_$LLVM_VERSION/rc1 $GOPATH/src/llvm.org/llvm
 # install the bindings to gopath
 - export CGO_CPPFLAGS="`llvm-config-3.6 --cppflags`"
 - export CGO_LDFLAGS="`llvm-config-3.6 --ldflags --libs --system-libs all`"
 - export CGO_CXXFLAGS=-std=c++11
 - go install -tags byollvm llvm.org/llvm/bindings/go/llvm

# our stuff goes here
script:
 - go get -v -tags byollvm ./...
 - go install -v -tags byollvm ./...
 - ./test.py
